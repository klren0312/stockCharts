<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>铜官区口罩预约状态查看</title>
  <link href="https://cdn.bootcss.com/element-ui/2.12.0/theme-chalk/index.css" rel="stylesheet">
</head>

<body>
  <div id="app">
    <el-table :data="tableData" style="width: 100%;margin-bottom: 20px;"
      row-key="id"
      border
      default-expand-all
      :tree-props="{children: 'children', hasChildren: 'hasChildren'}">
      <el-table-column prop="deptName" label="社区名称" min-width="180">
      </el-table-column>
      <el-table-column prop="email" label="药店地址"></el-table-column>
      <el-table-column prop="searchValue" label="剩余预约数量">
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope=scope>
          <div>
            <el-button v-if="scope.row.searchValue" size="mini" type="primary" @click="toOrder">前往预约</el-button>
          </div>
        </template>
      </el-table-column>
    </el-table>
  </div>
  <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
  <script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script>
  <script src="https://cdn.bootcss.com/element-ui/2.12.0/index.js"></script>
  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          tableData: []
        }
      },
      async mounted() {
        await this.getXq()
        await this.getYf()
      },
      methods: {
        async getXq() {
          const xq = await axios.post('http://122.51.46.108:8989/register/getCity?parendId=101').then(res => res.data.object)
          xq.forEach((v, i) => {
            v.children = []
            v.id = i + ''
          })
          this.tableData = xq
        },
        async getYf () {
          this.tableData.forEach(async (v, i) => {
            const yf = await axios.post('http://122.51.46.108:8989/register/getCity?parendId=' + v.deptId).then(res => res.data.object)
            yf.forEach(async (u, j) => {
              u.id = i + '000' + j
              u.searchValue = '正在获取...'
              u.email = '正在获取...'
              const nums = await axios.post('http://122.51.46.108:8989/register/getCityInfo?deptId=' + u.deptId).then(res => res.data.object)
              u.searchValue = nums.searchValue
              u.email = nums.email
            })
            v.children = yf
          })
        },
        toOrder () {
          window.open('http://122.51.46.108:8989/register?from=groupmessage')
        }

      }
    })
  </script>
</body>

</html>