<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>铜官区口罩预约状态查看</title>
  <link href="./js/ele.css" rel="stylesheet">
  <style>
    body {
      background-image: linear-gradient( 135deg, #43CBFF 10%, #9708CC 100%);
      color: #fff;
    }
    .header {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .header .btn {
      margin-left: 20px;
    }
    .select-input {
      width: 100%;
    }
    .qbtn {
      margin: 20px 0;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="app">
    <strong>注意:</strong>
    <div>方法1. 先点击预填写填写信息, 然后在表格相应的药房后点击预约按钮即可预约</div>
    <div>方法2. 可以在预填写中选择药房, 随后点击快速预约可直接预约!!!</div>
    <div>治电平台预约成功人数: <strong>{{hasSuccessNum * 10}}</strong>  位, 共助力获取口罩数约 <strong> {{hasSuccessNum * 5 * 10}} </strong>个;</div>
    <div>治电科技, 无知, 无畏, 自负, 自强!</div>
    <div class="header">
      <div class="btn"><el-button size="mini" type="danger" @click="open">预填写</el-button></div>
      <div class="btn"><el-button size="mini" @click="refresh">刷新(9点勿刷新)</el-button></div>
      <div class="btn"><el-button size="mini" @click="closeAndOpen"><span v-if="closeStatus">展开</span><span v-else>收起</span>小区</el-button></div>
    </div>
    <el-button class="qbtn" type="warning" @click="quickOrder">快速预约</el-button>
    <el-table :data="tableData" style="width: 100%;margin-bottom: 20px;"
      row-key="id"
      ref="tableEle"
      border
      default-expand-all
      :tree-props="{children: 'children', hasChildren: 'hasChildren'}">
      <el-table-column prop="deptId" label="药店ID" width="60">
        <template slot-scope=scope>
          <div>
            <div v-if="scope.row.searchValue">{{scope.row.deptId}}</div>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="deptName" label="药店名称" min-width="200">
        <template slot-scope="scope">
          <div>
            <strong >{{scope.row.deptName}}</strong>
            <span v-if="scope.row.searchValue"> (剩余预约数量: {{scope.row.searchValue}} 个)</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope=scope>
          <div>
            <el-button v-if="scope.row.searchValue" size="mini" type="primary" @click="toOrder(scope.row.deptId)">前往预约</el-button>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="email" label="药店地址" min-width="200"></el-table-column>
    </el-table>
    <el-dialog
      title="信息填写"
      :visible.sync="dialog"
      width="80%">
      <el-form ref="form" :model="form" label-width="80px">
        <el-form-item label="姓名">
          <el-input v-model="form.name" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="手机号">
          <el-input v-model="form.mobilePhone" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="身份证号">
          <el-input v-model="form.idCard" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="住宅地址">
          <el-input v-model="form.userAddress" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="小区">
          <el-select class="select-input" size="mini" clearable filterable v-model="selectXq" @change="xqChange">
            <el-option v-for="v in tableData" :key="v.deptId" :value="v.deptId" :label="v.deptName"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="药房">
          <el-select class="select-input" size="mini" clearable filterable v-model="form.shopId">
            <el-option v-for="v in yf" :key="v.deptId" :value="v.deptId" :label="v.deptName"></el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button type="primary" @click="confirm" size="mini">确 定</el-button>
      </span>
    </el-dialog>
  </div>
  <script src="./js/vue.min.js"></script>
  <script src="./js/axios.js"></script>
  <script src="./js/ele.js"></script>
  <script src="./js/bmob.js"></script>
  <script>
    Bmob.initialize('119947231f592fd5', 'qwer12')
    const query = Bmob.Query('success');
    new Vue({
      el: '#app',
      data() {
        return {
          tableData: [],
          ROOTURL: 'http://122.51.46.108:8989',
          dialog: false,
          form: {
            name: '',
            mobilePhone: '',
            idCard: '',
            userAddress: '',
            shopId: ''
          },
          closeStatus: false,
          selectXq: '',
          yf: '',
          hasSuccessNum: 0
        }
      },
      async mounted() {
        try {
          const info = localStorage.getItem('info')
          if (info) {
            this.form = JSON.parse(info)
          }  
        } catch (error) {}
        await this.getXq()
        await this.getYf()

        query.get('NeQg1115')
          .then(res => res.num)
          .then(n => {
            this.hasSuccessNum = n
          })
      },
      methods: {
        closeAndOpen () {
          this.closeStatus = !this.closeStatus
          this.tableData.forEach(v => {
            this.$refs.tableEle.toggleRowExpansion(v, !this.closeStatus)
          })
        },
        xqChange (v) {
          const yf = this.tableData.filter(x => x.deptId === v)[0].children
          this.yf = yf
        },
        async getXq() {
          const xq = await axios.post(`${this.ROOTURL}/register/getCity?parendId=101`).then(res => res.data.object)
          xq.forEach((v, i) => {
            v.children = []
            v.id = i + ''
          })
          this.tableData = xq
        },
        async getYf () {
          this.tableData.forEach(async (v, i) => {
            const yf = await axios.post(`${this.ROOTURL}/register/getCity?parendId=` + v.deptId).then(res => res.data.object)
            yf.forEach(async (u, j) => {
              u.id = i + '000' + j
              u.searchValue = '正在获取...'
              u.email = '正在获取...'
              const nums = await axios.post(`${this.ROOTURL}/register/getCityInfo?deptId=` + u.deptId).then(res => res.data.object)
              u.searchValue = nums.searchValue
              u.email = nums.email
            })
            v.children = yf
          })
        },
        async toOrder (id) {
          const form = JSON.parse(JSON.stringify(this.form))
          form.shopId = id
          const params = new URLSearchParams()
          Object.keys(form).forEach(v => {
            params.append(v, form[v])
          })
          const result = await axios.post(`${this.ROOTURL}/register/login`, params).then(res => res.data)
          this.$message.error(result.msg)
          if (result.msg.match('成功')) {
            query.set('id', 'NeQg1115') //需要修改的objectId
              query.set('num', ++this.hasSuccessNum)
              query.save().then(res => {
              }).catch(err => {
              })
          }
        },
        async quickOrder () {
          const params = new URLSearchParams()
          Object.keys(this.form).forEach(v => {
            params.append(v, this.form[v])
          })
          const result = await axios.post(`${this.ROOTURL}/register/login`, params).then(res => res.data)
          this.$message.error(result.msg)
        },
        open () {
          try {
            const info = localStorage.getItem('info')
            if (info) {
              this.form = JSON.parse(info)
            }  
          } catch (error) {}
          
          this.dialog = true
        },
        confirm () {
          localStorage.setItem('info', JSON.stringify(this.form))
          this.dialog = false
        },
        async refresh () {
          await this.getXq()
          await this.getYf()
        }
      }
    })
  </script>
</body>

</html>