<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>铜官区口罩预约状态查看</title>
  <link href="https://cdn.bootcss.com/element-ui/2.12.0/theme-chalk/index.css" rel="stylesheet">
  <style>
    .header {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header">
      <div>铜官区口罩预约状态</div>
      <div><el-button size="mini" type="success" @click="open">信息预填写</el-button></div>
    </div>
    <el-table :data="tableData" style="width: 100%;margin-bottom: 20px;"
      row-key="id"
      border
      default-expand-all
      :tree-props="{children: 'children', hasChildren: 'hasChildren'}">
      <el-table-column prop="deptId" label="药店ID" width="60">
        <template slot-scope=scope>
          <div>
            <div v-if="scope.row.searchValue">{{scope.row.deptId}}</div>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="deptName" label="药店名称" min-width="200"></el-table-column>
      <el-table-column prop="searchValue" label="剩余预约数量"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope=scope>
          <div>
            <el-button v-if="scope.row.searchValue" size="mini" type="primary" @click="toOrder(scope.row.deptId)">前往预约</el-button>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="email" label="药店地址" min-width="200"></el-table-column>
    </el-table>
    <el-dialog
      title="信息填写"
      :visible.sync="dialog"
      width="80%">
      <el-form ref="form" :model="form" label-width="80px">
        <el-form-item label="姓名">
          <el-input v-model="form.name" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="手机号">
          <el-input v-model="form.mobilePhone" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="身份证号">
          <el-input v-model="form.idCard" size="mini"></el-input>
        </el-form-item>
        <el-form-item label="住宅地址">
          <el-input v-model="form.userAddress" size="mini"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button type="primary" @click="confirm" size="mini">确 定</el-button>
      </span>
    </el-dialog>
  </div>
  <h1>治电科技</h1>
  <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
  <script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script>
  <script src="https://cdn.bootcss.com/element-ui/2.12.0/index.js"></script>
  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          tableData: [],
          ROOTURL: 'http://122.51.46.108:8989',
          dialog: false,
          form: {
            name: '',
            mobilePhone: '',
            idCard: '',
            userAddress: '',
            shopId: ''
          }
        }
      },
      async mounted() {
        try {
          const info = localStorage.getItem('info')
          if (info) {
            this.form = JSON.parse(info)
          }  
        } catch (error) {}
        await this.getXq()
        await this.getYf()
        // setInterval(async () => {
        //   await this.getXq()
        //   await this.getYf()
        // }, 60000)
        
      },
      methods: {
        async getXq() {
          const xq = await axios.post(`${this.ROOTURL}/register/getCity?parendId=101`).then(res => res.data.object)
          xq.forEach((v, i) => {
            v.children = []
            v.id = i + ''
          })
          this.tableData = xq
        },
        async getYf () {
          this.tableData.forEach(async (v, i) => {
            const yf = await axios.post(`${this.ROOTURL}/register/getCity?parendId=` + v.deptId).then(res => res.data.object)
            yf.forEach(async (u, j) => {
              u.id = i + '000' + j
              u.searchValue = '正在获取...'
              u.email = '正在获取...'
              const nums = await axios.post(`${this.ROOTURL}/register/getCityInfo?deptId=` + u.deptId).then(res => res.data.object)
              u.searchValue = nums.searchValue
              u.email = nums.email
            })
            v.children = yf
          })
        },
        async toOrder (id) {
          this.form.shopId = id
          const params = new URLSearchParams()
          Object.keys(this.form).forEach(v => {
            params.append(v, this.form[v])
          })
          const result = await axios.post(`${this.ROOTURL}/register/login`, params).then(res => res.data)
          this.$message.error(result.msg)
        },
        open () {
          try {
            const info = localStorage.getItem('info')
            if (info) {
              this.form = JSON.parse(info)
            }  
          } catch (error) {}
          
          this.dialog = true
        },
        confirm () {
          localStorage.setItem('info', JSON.stringify(this.form))
          this.dialog = false
        }
      }
    })
  </script>
</body>

</html>